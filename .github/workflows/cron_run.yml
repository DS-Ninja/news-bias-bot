- name: Call /run endpoint (warm + retry)
  env:
    RUN_TOKEN: ${{ secrets.RUN_TOKEN }}
  run: |
    set -euo pipefail

    BASE="https://web-production-9bcf3.up.railway.app"
    URL="$BASE/run?token=${RUN_TOKEN}"

    echo "Warmup /health ..."
    curl -4 -fSs --connect-timeout 10 --max-time 120 "$BASE/health?pretty=1" > /dev/null || true
    sleep 3

    for i in 1 2 3 4 5; do
      echo "Attempt $i..."
      if curl -4 -fSs --connect-timeout 10 --max-time 240 "$URL" > /dev/null; then
        echo "OK: /run triggered"
        exit 0
      fi
      sleep $((i*5))
    done

    echo "ERROR: /run failed after retries"
    exit 1
