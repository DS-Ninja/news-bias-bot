name: Run pipeline every 5 minutes

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Call /run endpoint (GET + token)
        env:
          RUN_TOKEN: ${{ secrets.RUN_TOKEN }}
        run: |
          set -euo pipefail

          URL="https://web-production-9bcf3.up.railway.app/run?token=${RUN_TOKEN}"

          for i in 1 2 3 4 5; do
            echo "Attempt $i..."
            if curl -fsS --max-time 60 "$URL" > /dev/null; then
              echo "OK: /run triggered (GET)"
              exit 0
            fi
            sleep $((i*3))
          done

          echo "ERROR: /run failed after retries"
          exit 1
